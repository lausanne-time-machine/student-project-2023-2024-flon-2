/**
 * Bundled by jsDelivr using Rollup v2.79.1 and Terser v5.19.2.
 * Original file: /npm/leaflet.offline@3.0.1/dist/bundle.js
 *
 * Do NOT use SRI with dynamically generated files! More information: https://www.jsdelivr.com/using-sri-with-dynamic-files
 */
import t from"../leaflet@1.9.4/_esm.js";import e from"../idb@7.1.1/_esm.js";"undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self&&self;var s={exports:{}};!function(t,e,s){const o="tileStore",i="urlTemplate";let n;function a(){return n||(n=s.openDB("leaflet.offline",2,{upgrade(t,e){if(s.deleteDB("leaflet_offline"),s.deleteDB("leaflet_offline_areas"),e<1){const e=t.createObjectStore(o,{keyPath:"key"});e.createIndex(i,"urlTemplate"),e.createIndex("z","z")}}}),n)}async function r(){return(await a()).count(o)}async function l(t){const e=IDBKeyRange.only(t);return(await a()).getAllFromIndex(o,i,e)}async function h(t){const e=await fetch(t);if(!e.ok)throw new Error(`Request failed with status ${e.statusText}`);return e.blob()}async function u(t,e){return(await a()).put(o,{blob:e,...t})}function c(t,s){return e.Util.template(t,{...s,r:e.Browser.retina?"@2x":""})}function f(t,s){const o=[];if(!t.min||!t.max)return o;const i=t.min.divideBy(s.x).floor(),n=t.max.divideBy(s.x).floor();for(let t=i.y;t<=n.y;t+=1)for(let s=i.x;s<=n.x;s+=1)o.push(new e.Point(s,t));return o}function g(t,s){const o={type:"FeatureCollection",features:[]};for(let i=0;i<s.length;i+=1){const n=new e.Point(s[i].x*t.getTileSize().x,s[i].y*t.getTileSize().y),a=new e.Point(n.x+t.getTileSize().x,n.y+t.getTileSize().y),r=e.CRS.EPSG3857.pointToLatLng(n,s[i].z),l=e.CRS.EPSG3857.pointToLatLng(a,s[i].z);o.features.push({type:"Feature",properties:s[i],geometry:{type:"Polygon",coordinates:[[[r.lng,r.lat],[l.lng,r.lat],[l.lng,l.lat],[r.lng,l.lat],[r.lng,r.lat]]]}})}return o}async function d(t){return(await a()).delete(o,t)}async function p(t){return(await a()).get(o,t).then((t=>t&&t.blob))}async function m(t){const e=await a();return void 0!==await e.getKey(o,t)}async function y(){return(await a()).clear(o)}class v extends e.TileLayer{createTile(t,s){const o=document.createElement("img");return e.DomEvent.on(o,"load",e.Util.bind(this._tileOnLoad,this,s,o)),e.DomEvent.on(o,"error",e.Util.bind(this._tileOnError,this,s,o)),(this.options.crossOrigin||""===this.options.crossOrigin)&&(o.crossOrigin=!0===this.options.crossOrigin?"":this.options.crossOrigin),o.alt="",o.setAttribute("role","presentation"),this.setDataUrl(t).then((t=>o.src=t)).catch((()=>o.src=this.getTileUrl(t))),o}setDataUrl(t){return p(this._getStorageKey(t)).then((t=>{if(t&&"object"==typeof t)return URL.createObjectURL(t);throw new Error("tile not found in storage")}))}_getStorageKey(t){return c(this._url,{...t,...this.options,s:this.options.subdomains[0]})}getTileUrls(t,e){const s=[],o=f(t,this.getTileSize());for(let t=0;t<o.length;t+=1){const i=o[t],n={...this.options,x:i.x,y:i.y,z:e+(this.options.zoomOffset||0)};s.push({key:c(this._url,{...n,s:this.options.subdomains?.[0]}),url:c(this._url,{...n,s:this._getSubdomain(i)}),z:e,x:i.x,y:i.y,urlTemplate:this._url,createdAt:Date.now()})}return s}}function w(t,e){return new v(t,e)}window.L&&(window.L.tileLayer.offline=w);class _ extends e.Control{status={storagesize:0,lengthToBeSaved:0,lengthSaved:0,lengthLoaded:0,_tilesforSave:[]};constructor(t,e){super(e),this._baseLayer=t,this.setStorageSize(),this.options={position:"topleft",saveText:"+",rmText:"-",maxZoom:19,saveWhatYouSee:!1,bounds:null,confirm:null,confirmRemoval:null,parallel:50,zoomlevels:void 0,alwaysDownload:!0,...e}}setStorageSize(){return this.status.storagesize?Promise.resolve(this.status.storagesize):r().then((t=>(this.status.storagesize=t,this._baseLayer.fire("storagesize",this.status),t))).catch((()=>0))}getStorageSize(t){this.setStorageSize().then((e=>{t&&t(e)}))}setLayer(t){this._baseLayer=t}onAdd(){const t=e.DomUtil.create("div","savetiles leaflet-bar"),{options:s}=this;return this._createButton(s.saveText,"savetiles",t,this._saveTiles),this._createButton(s.rmText,"rmtiles",t,this._rmTiles),t}_createButton(t,s,o,i){const n=e.DomUtil.create("a",s,o);return n.innerHTML=t,n.href="#",n.ariaRoleDescription="button",e.DomEvent.on(n,"mousedown dblclick",e.DomEvent.stopPropagation).on(n,"click",e.DomEvent.stop).on(n,"click",i,this).on(n,"click",this._refocusOnMap,this),n}_saveTiles(){const t=this._calculateTiles();this._resetStatus(t);const e=async()=>{this._baseLayer.fire("savestart",this.status);const e=async()=>{const s=t.shift();if(void 0===s)return Promise.resolve();const o=await this._loadTile(s);return o&&await this._saveTile(s,o),e()},s=Math.min(t.length,this.options.parallel);for(let t=0;t<s;t+=1)e()};this.options.confirm?this.options.confirm(this.status,e):e()}_calculateTiles(){let t=[];const s=5;let o=[];if(this.options.saveWhatYouSee){const t=this._map.getZoom();if(t<s)throw new Error(`It's not possible to save with zoom below level ${s}.`);const{maxZoom:e}=this.options;for(let s=t;s<=e;s+=1)o.push(s)}else o=this.options.zoomlevels||[this._map.getZoom()];const i=this.options.bounds||this._map.getBounds();for(let s=0;s<o.length;s+=1){const n=e.bounds(this._map.project(i.getNorthWest(),o[s]),this._map.project(i.getSouthEast(),o[s]));t=t.concat(this._baseLayer.getTileUrls(n,o[s]))}return t}_resetStatus(t){this.status={lengthLoaded:0,lengthToBeSaved:t.length,lengthSaved:0,_tilesforSave:t,storagesize:this.status.storagesize}}async _loadTile(t){let e;return!0!==this.options.alwaysDownload&&!1!==await m(t.key)||(e=await h(t.url),this.status.lengthLoaded+=1),this.status.lengthLoaded+=1,this._baseLayer.fire("loadtileend",this.status),this.status.lengthLoaded===this.status.lengthToBeSaved&&this._baseLayer.fire("loadend",this.status),e}async _saveTile(t,e){await u(t,e),this.status.lengthSaved+=1,this._baseLayer.fire("savetileend",this.status),this.status.lengthSaved===this.status.lengthToBeSaved&&(this._baseLayer.fire("saveend",this.status),this.setStorageSize())}_rmTiles(){const t=()=>{y().then((()=>{this.status.storagesize=0,this._baseLayer.fire("tilesremoved"),this._baseLayer.fire("storagesize",this.status)}))};this.options.confirmRemoval?this.options.confirmRemoval(this.status,t):t()}}function S(t,e){return new _(t,e)}window.L&&(window.L.control.savetiles=S),t.downloadTile=h,t.getBlobByKey=p,t.getStorageInfo=l,t.getStorageLength=r,t.getStoredTilesAsJson=g,t.removeTile=d,t.saveTile=u,t.savetiles=S,t.tileLayerOffline=w,t.truncate=y}(s.exports,t,e);var o=s.exports,i=s.exports.downloadTile,n=s.exports.getBlobByKey,a=s.exports.getStorageInfo,r=s.exports.getStorageLength,l=s.exports.getStoredTilesAsJson,h=s.exports.removeTile,u=s.exports.saveTile,c=s.exports.savetiles,f=s.exports.tileLayerOffline,g=s.exports.truncate;export{o as default,i as downloadTile,n as getBlobByKey,a as getStorageInfo,r as getStorageLength,l as getStoredTilesAsJson,h as removeTile,u as saveTile,c as savetiles,f as tileLayerOffline,g as truncate};
